<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeFlow - Your AI Productivity Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Track your productivity with AI assistance, voice input, and smart analytics">
    <meta name="theme-color" content="#10b981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TimeFlow">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect width='192' height='192' fill='%2310b981'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='120' fill='white'>‚ö°</text></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --productive: #10b981;
            --neutral: #fbbf24;
            --unproductive: #ef4444;
            --bg-dark: #0f1419;
            --bg-card: #1a1f29;
            --text-primary: #e4e6eb;
            --text-secondary: #8b92a8;
            --accent: #3b82f6;
            --border: #2d3748;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--bg-card) 0%, #252d3d 100%);
            padding: 2rem 2rem 1.5rem;
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        h1 {
            font-family: 'Space Mono', monospace;
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--productive), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .settings-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            background: var(--border);
            transform: translateY(-2px);
        }

        .date-selector {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .date-nav {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: var(--border);
            transform: translateY(-2px);
        }

        .date-selector input {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.6rem 1rem;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-card);
            padding: 0.3rem;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .view-toggle button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            transition: all 0.3s ease;
        }

        .view-toggle button.active {
            background: var(--accent);
            color: white;
        }

        .voice-input-section {
            background: var(--bg-card);
            padding: 1.5rem;
            margin: 2rem;
            border-radius: 12px;
            border: 2px solid var(--border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .input-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .voice-input {
            flex: 1;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 1rem 1.2rem;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .voice-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .voice-btn {
            background: var(--accent);
            border: none;
            color: white;
            padding: 1rem 2rem;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .voice-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .voice-btn.listening {
            background: var(--unproductive);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .color-selector {
            display: flex;
            gap: 0.8rem;
            justify-content: center;
        }

        .color-btn {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        .color-btn.selected {
            border-color: white;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.2);
        }

        .color-btn.green { background: var(--productive); }
        .color-btn.yellow { background: var(--neutral); }
        .color-btn.red { background: var(--unproductive); }

        .schedule-container {
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .day-view, .week-view {
            display: none;
        }

        .day-view.active, .week-view.active {
            display: block;
        }

        .timeline {
            display: grid;
            gap: 0.5rem;
        }

        .time-block {
            display: grid;
            grid-template-columns: 180px 1fr;
            gap: 1rem;
            align-items: center;
            padding: 0.8rem;
            background: var(--bg-card);
            border-radius: 8px;
            border-left: 4px solid var(--border);
            transition: all 0.3s ease;
        }

        .time-block.filled {
            border-left-width: 6px;
        }

        .time-block.filled.productive { border-left-color: var(--productive); background: rgba(16, 185, 129, 0.1); }
        .time-block.filled.neutral { border-left-color: var(--neutral); background: rgba(251, 191, 36, 0.1); }
        .time-block.filled.unproductive { border-left-color: var(--unproductive); background: rgba(239, 68, 68, 0.1); }

        .time-block.filled {
            cursor: pointer;
            position: relative;
        }

        .time-block.filled:hover {
            opacity: 0.7;
        }

        .time-block.filled:hover::after {
            content: 'üóëÔ∏è Click to clear';
            position: absolute;
            right: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .time-label {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .time-content {
            color: var(--text-primary);
            font-size: 0.95rem;
            min-height: 20px;
        }

        .time-content.empty {
            color: var(--text-secondary);
            font-style: italic;
        }

        .week-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .week-header {
            background: var(--bg-card);
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid var(--border);
        }

        .week-cell {
            background: var(--bg-card);
            padding: 0.8rem;
            min-height: 50px;
            font-size: 0.85rem;
        }

        .week-cell.time-label {
            background: var(--bg-dark);
            font-family: 'Space Mono', monospace;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid var(--border);
            text-align: center;
        }

        .stat-value {
            font-family: 'Space Mono', monospace;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }

        .stat-card.productive .stat-value { color: var(--productive); }
        .stat-card.neutral .stat-value { color: var(--neutral); }
        .stat-card.unproductive .stat-value { color: var(--unproductive); }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .motivation-banner {
            background: linear-gradient(135deg, var(--productive), var(--accent));
            padding: 1.5rem;
            margin: 2rem;
            border-radius: 12px;
            text-align: center;
            animation: slideIn 0.5s ease;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }

        .motivation-banner h2 {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            font-family: 'Space Mono', monospace;
        }

        .motivation-banner p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }

        .comparison-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 2rem;
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            border-bottom: 1px solid var(--border);
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        .comparison-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .comparison-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .comparison-value.better {
            color: var(--productive);
        }

        .comparison-value.worse {
            color: var(--unproductive);
        }

        .streak-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid var(--border);
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .setting-item {
            margin-bottom: 1.5rem;
        }

        .setting-item label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .setting-item input,
        .setting-item select {
            width: 100%;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.7rem;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal-buttons button {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .ai-chat-container {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 2px solid var(--border);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
            transition: right 0.3s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }

        .ai-chat-container.active {
            right: 0;
        }

        .ai-chat-header {
            background: linear-gradient(135deg, var(--accent), var(--productive));
            padding: 1.5rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-header h3 {
            font-family: 'Space Mono', monospace;
            font-size: 1.2rem;
        }

        .ai-chat-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .ai-message, .user-message {
            padding: 1rem;
            border-radius: 12px;
            max-width: 85%;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-message {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            align-self: flex-start;
        }

        .user-message {
            background: var(--accent);
            color: white;
            align-self: flex-end;
        }

        .message-label {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .message-content {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .ai-chat-input {
            padding: 1.5rem;
            border-top: 2px solid var(--border);
            background: var(--bg-dark);
        }

        .ai-input-box {
            display: flex;
            gap: 0.5rem;
        }

        .ai-input-box textarea {
            flex: 1;
            background: var(--bg-card);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.8rem;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 0.95rem;
            resize: none;
            min-height: 60px;
        }

        .ai-input-box textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .ai-send-btn {
            background: var(--accent);
            border: none;
            color: white;
            padding: 0.8rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            transition: all 0.3s ease;
        }

        .ai-send-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .ai-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            gap: 0.3rem;
            padding: 1rem;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.5;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .quick-action-btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.5rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-action-btn:hover {
            background: var(--border);
            transform: translateY(-2px);
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-secondary {
            background: var(--border);
            color: var(--text-primary);
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary:hover {
            background: #374151;
        }

        .examples {
            background: var(--bg-dark);
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .examples strong {
            color: var(--text-primary);
            display: block;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <h1>‚ö° TimeFlow</h1>
            <div style="display: flex; gap: 1rem;">
                <button class="settings-btn" onclick="toggleAIChat()">ü§ñ Chat with AI</button>
                <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
            </div>
        </div>
        <div class="date-selector">
            <div class="date-nav">
                <button class="nav-btn" onclick="changeWeek(-1)">‚Üê Prev Week</button>
                <input type="date" id="dateInput" value="">
                <button class="nav-btn" onclick="changeWeek(1)">Next Week ‚Üí</button>
                <button class="nav-btn" onclick="goToToday()">Today</button>
            </div>
            <div class="view-toggle">
                <button class="active" onclick="switchView('day')">Day</button>
                <button onclick="switchView('week')">Week</button>
            </div>
        </div>
    </div>

    <div class="motivation-banner" id="motivationBanner" style="display: none;">
        <h2 id="motivationTitle">üî• Keep Going!</h2>
        <p id="motivationMessage">Track your day to see how you're doing!</p>
        <div id="streakBadge"></div>
    </div>

    <div class="comparison-card" id="comparisonCard" style="display: none;">
        <div class="comparison-row">
            <span class="comparison-label">Yesterday</span>
            <span class="comparison-value" id="yesterdayValue">-</span>
        </div>
        <div class="comparison-row">
            <span class="comparison-label">Today</span>
            <span class="comparison-value" id="todayValue">-</span>
        </div>
        <div class="comparison-row">
            <span class="comparison-label">Difference</span>
            <span class="comparison-value" id="differenceValue">-</span>
        </div>
    </div>

    <div class="voice-input-section">
        <div class="input-container">
            <input 
                type="text" 
                class="voice-input" 
                id="activityInput" 
                placeholder="Say or type: '9 to 9:30 studying CS' or just 'studying CS' for current time..."
            >
            <button class="voice-btn" id="voiceBtn" onclick="toggleRecording()">
                üé§ Record
            </button>
            <button class="voice-btn" onclick="logActivity()">
                ‚úÖ Log
            </button>
        </div>
        <div class="color-selector">
            <button class="color-btn green selected" data-color="productive" onclick="selectColor('productive')"></button>
            <button class="color-btn yellow" data-color="neutral" onclick="selectColor('neutral')"></button>
            <button class="color-btn red" data-color="unproductive" onclick="selectColor('unproductive')"></button>
        </div>
        <div class="examples">
            <strong>Examples (ALWAYS use AM/PM):</strong>
            ‚Ä¢ "9 am to 10 am studying" ‚Ä¢ "2 pm to 3 pm gym" ‚Ä¢ "7 pm to 8 pm dinner"
            <br><strong>‚ö†Ô∏è Important:</strong> Always add AM or PM! Without it, times might go to wrong slots.
        </div>
    </div>

    <div class="stats">
        <div class="stat-card productive">
            <div class="stat-label">Productive Hours</div>
            <div class="stat-value" id="productiveHours">0</div>
        </div>
        <div class="stat-card neutral">
            <div class="stat-label">Neutral Hours</div>
            <div class="stat-value" id="neutralHours">0</div>
        </div>
        <div class="stat-card unproductive">
            <div class="stat-label">Unproductive Hours</div>
            <div class="stat-value" id="unproductiveHours">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Productivity Score</div>
            <div class="stat-value" id="productivityScore" style="color: var(--accent);">0%</div>
        </div>
    </div>

    <div class="schedule-container">
        <div class="day-view active" id="dayView">
            <div class="timeline" id="timeline"></div>
        </div>
        <div class="week-view" id="weekView">
            <div class="week-grid" id="weekGrid"></div>
        </div>
    </div>

    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2>‚öôÔ∏è Settings</h2>
            
            <div class="setting-item">
                <label>OpenAI API Key (for AI Assistant)</label>
                <input type="password" id="apiKeyInput" placeholder="sk-..." style="font-family: monospace;">
                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                    Get your key at <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--accent);">platform.openai.com</a>. Stored locally, never shared.
                </small>
            </div>

            <div class="setting-item">
                <label>ü§ñ AI Check-in Frequency</label>
                <select id="aiCheckinInterval">
                    <option value="0">Off (No automatic check-ins)</option>
                    <option value="15">Every 15 minutes</option>
                    <option value="30" selected>Every 30 minutes</option>
                    <option value="60">Every 1 hour</option>
                    <option value="120">Every 2 hours</option>
                    <option value="180">Every 3 hours</option>
                </select>
                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                    AI will check in with you based on your activity
                </small>
            </div>

            <div class="setting-item">
                <label>AI Check-in Types</label>
                <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="checkinInactivity" checked>
                        <span>Inactivity reminders (when you haven't logged)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="checkinStreak" checked>
                        <span>Streak protection (don't break your streak!)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="checkinPraise" checked>
                        <span>Productivity praise (celebrate your wins!)</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="checkinEndOfDay" checked>
                        <span>End of day review (reflect on your day)</span>
                    </label>
                </div>
            </div>

            <div class="setting-item">
                <label>Do Not Disturb Hours (Optional)</label>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="time" id="dndStart" style="flex: 1;">
                    <span>to</span>
                    <input type="time" id="dndEnd" style="flex: 1;">
                </div>
                <small style="color: var(--text-secondary); display: block; margin-top: 0.5rem;">
                    No AI check-ins during these hours. Leave blank for no restriction.
                </small>
            </div>
            
            <div class="setting-item">
                <label>Day Start Time</label>
                <input type="time" id="dayStart" value="05:00">
            </div>
            
            <div class="setting-item">
                <label>Day End Time</label>
                <input type="time" id="dayEnd" value="23:59">
            </div>
            
            <div class="setting-item">
                <label>Time Block Interval (minutes)</label>
                <select id="intervalSelect">
                    <option value="5">5 minutes</option>
                    <option value="10">10 minutes</option>
                    <option value="15">15 minutes</option>
                    <option value="30" selected>30 minutes</option>
                    <option value="60">60 minutes</option>
                </select>
            </div>
            
            <div class="modal-buttons">
                <button class="btn-primary" onclick="saveSettings()">Save</button>
                <button class="btn-secondary" onclick="closeSettings()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="ai-chat-container" id="aiChatContainer">
        <div class="ai-chat-header">
            <h3>ü§ñ Your AI Assistant</h3>
            <button class="ai-chat-close" onclick="toggleAIChat()">‚úï</button>
        </div>
        <div class="ai-chat-messages" id="aiMessages">
            <!-- Messages will appear here -->
        </div>
        <div class="ai-chat-input">
            <div class="quick-actions">
                <button class="quick-action-btn" onclick="sendQuickMessage('What should I do now?')">What should I do now?</button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Help me plan my day')">Plan my day</button>
                <button class="quick-action-btn" onclick="sendQuickMessage('How productive was I today?')">Today's summary</button>
            </div>
            <div class="ai-input-box">
                <textarea id="aiInput" placeholder="Ask me anything or tell me about your day..."></textarea>
                <button class="ai-send-btn" id="aiRecordBtn" onclick="toggleAIRecording()" style="background: var(--productive);">üé§</button>
                <button class="ai-send-btn" id="aiSendBtn" onclick="sendAIMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // App State
        let currentView = 'day';
        let selectedColor = 'productive';
        let currentDate = new Date();
        let settings = {
            dayStart: '05:00',
            dayEnd: '23:59',
            interval: 30,
            aiCheckinInterval: 30, // minutes
            checkinInactivity: true,
            checkinStreak: true,
            checkinPraise: true,
            checkinEndOfDay: true,
            dndStart: '',
            dndEnd: ''
        };
        let schedule = {};
        let lastCheckinTime = Date.now();
        let lastActivityTime = Date.now();
        let aiCheckinTimer = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadSchedule();
            initDate();
            initSpeechRecognition();
            renderTimeline();
            updateStats();
            startAICheckinSystem(); // Start AI check-in timer
        });

        function initDate() {
            const dateInput = document.getElementById('dateInput');
            dateInput.value = currentDate.toISOString().split('T')[0];
            dateInput.addEventListener('change', (e) => {
                currentDate = new Date(e.target.value);
                renderTimeline();
                updateStats();
            });
        }

        function initSpeechRecognition() {
            // Using OpenAI Whisper API instead of browser speech recognition
            // This works on ALL devices including mobile!
        }

        // New Whisper-based recording
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        async function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }

        async function startRecording() {
            try {
                // Check if we're on HTTPS or localhost
                const isSecure = window.location.protocol === 'https:' || 
                                window.location.hostname === 'localhost' || 
                                window.location.hostname === '127.0.0.1';
                
                if (!isSecure && /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                    alert('üì± Voice recording on mobile requires HTTPS.\n\n‚úÖ Quick fix:\n1. Upload this file to GitHub Pages (free)\n2. Or use Netlify/Vercel (free)\n3. Or type manually (still works great!)\n\nWant help hosting it? Ask me in the AI chat!');
                    return;
                }

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await transcribeAudio(audioBlob);
                    
                    // Stop all tracks to release microphone
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;

                const btn = document.getElementById('voiceBtn');
                btn.classList.add('listening');
                btn.innerHTML = 'üî¥ Recording...';
                
            } catch (error) {
                console.error('Microphone error:', error);
                
                if (error.name === 'NotAllowedError') {
                    alert('üé§ Microphone Permission Denied\n\n' +
                          'üì± On Mobile:\n' +
                          '1. Go to browser Settings\n' +
                          '2. Find Site Settings or Permissions\n' +
                          '3. Allow Microphone access\n' +
                          '4. Refresh this page\n\n' +
                          'üí° Or: Voice works perfectly on desktop!\n' +
                          'For mobile, you can host this on GitHub Pages (free, 2 minutes).');
                } else if (error.name === 'NotFoundError') {
                    alert('No microphone found on this device.');
                } else {
                    alert('Could not access microphone: ' + error.message);
                }
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                const btn = document.getElementById('voiceBtn');
                btn.classList.remove('listening');
                btn.innerHTML = 'üé§ Record';
            }
        }

        async function transcribeAudio(audioBlob) {
            try {
                const btn = document.getElementById('voiceBtn');
                btn.innerHTML = '‚è≥ Processing...';
                btn.disabled = true;

                const apiKey = localStorage.getItem('openai_api_key');
                if (!apiKey) {
                    alert('Please add your OpenAI API key in Settings first!');
                    btn.innerHTML = 'üé§ Record';
                    btn.disabled = false;
                    return;
                }

                // Convert to proper audio format for Whisper
                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.webm');
                formData.append('model', 'whisper-1');
                formData.append('language', 'en');
                // Add prompt hint to help Whisper understand time formats better
                formData.append('prompt', 'Activity schedule with times like 9 AM, 2 PM, studying, gym, etc.');

                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Transcription failed');
                }

                const data = await response.json();
                const transcript = data.text;

                console.log('=== WHISPER TRANSCRIPTION ===');
                console.log('Raw Whisper output:', transcript);
                console.log('============================');

                // VISUAL DEBUG - Show what Whisper heard
                alert('WHISPER HEARD:\n"' + transcript + '"\n\nCheck if this is correct!');

                // Put transcribed text in input
                document.getElementById('activityInput').value = transcript;
                
                btn.innerHTML = 'üé§ Record';
                btn.disabled = false;
                
                showNotification('‚úÖ Transcribed: ' + transcript);

            } catch (error) {
                console.error('Transcription error:', error);
                alert('Could not transcribe audio. Please check your API key and try again.');
                
                const btn = document.getElementById('voiceBtn');
                btn.innerHTML = 'üé§ Record';
                btn.disabled = false;
            }
        }

        function selectColor(color) {
            selectedColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`.color-btn[data-color="${color}"]`).classList.add('selected');
        }

        function parseTimeInput(input) {
            input = input.toLowerCase().trim();
            
            // CRITICAL FIX: Replace periods with colons for time parsing
            // Whisper often transcribes "9.30" instead of "9:30"
            input = input.replace(/(\d+)\.(\d+)/g, '$1:$2');
            
            console.log('=== PARSING INPUT ===');
            console.log('Raw input:', input);
            console.log('After period fix:', input);
            
            // Pattern: "9 am to 10 am activity" or "9:00 to 9:30 activity" 
            const rangePattern = /(\d{1,2}):?(\d{2})?\s*(am|pm)?\s*(?:to|-)\s*(\d{1,2}):?(\d{2})?\s*(am|pm)?\s+(.+)/;
            const rangeMatch = input.match(rangePattern);
            
            if (rangeMatch) {
                // Extract all parts
                let startHour = parseInt(rangeMatch[1]);
                let startMin = rangeMatch[2] ? parseInt(rangeMatch[2]) : 0;
                let startPeriod = rangeMatch[3]; // 'am', 'pm', or undefined
                let endHour = parseInt(rangeMatch[4]);
                let endMin = rangeMatch[5] ? parseInt(rangeMatch[5]) : 0;
                let endPeriod = rangeMatch[6]; // 'am', 'pm', or undefined
                const activity = rangeMatch[7].trim();
                
                console.log('Extracted:', {
                    startHour, startMin, startPeriod,
                    endHour, endMin, endPeriod,
                    activity
                });
                
                // CRITICAL: If one time has AM/PM, copy it to the other
                if (startPeriod && !endPeriod) {
                    endPeriod = startPeriod;
                    console.log('Copied start period to end:', endPeriod);
                }
                if (!startPeriod && endPeriod) {
                    startPeriod = endPeriod;
                    console.log('Copied end period to start:', startPeriod);
                }
                
                // Convert to 24-hour format ONLY if AM/PM is present
                if (startPeriod) {
                    const oldStartHour = startHour;
                    if (startPeriod === 'pm' && startHour < 12) {
                        startHour = startHour + 12;
                    } else if (startPeriod === 'am' && startHour === 12) {
                        startHour = 0;
                    }
                    console.log(`Start: ${oldStartHour} ${startPeriod} ‚Üí ${startHour}:00 (24hr)`);
                }
                
                if (endPeriod) {
                    const oldEndHour = endHour;
                    if (endPeriod === 'pm' && endHour < 12) {
                        endHour = endHour + 12;
                    } else if (endPeriod === 'am' && endHour === 12) {
                        endHour = 0;
                    }
                    console.log(`End: ${oldEndHour} ${endPeriod} ‚Üí ${endHour}:00 (24hr)`);
                }
                
                // If NO AM/PM specified at all, treat as 24-hour
                if (!startPeriod && !endPeriod) {
                    console.log('No AM/PM specified - using 24-hour format');
                }
                
                // Round to interval boundaries
                const roundedStartMin = Math.floor(startMin / settings.interval) * settings.interval;
                let roundedEndMin = endMin;
                if (endMin % settings.interval !== 0) {
                    roundedEndMin = Math.ceil(endMin / settings.interval) * settings.interval;
                }
                
                // Handle minute overflow
                let finalEndHour = endHour;
                let finalEndMin = roundedEndMin;
                if (roundedEndMin >= 60) {
                    finalEndHour += Math.floor(roundedEndMin / 60);
                    finalEndMin = roundedEndMin % 60;
                }
                
                const result = {
                    startTime: `${String(startHour).padStart(2, '0')}:${String(roundedStartMin).padStart(2, '0')}`,
                    endTime: `${String(finalEndHour).padStart(2, '0')}:${String(finalEndMin).padStart(2, '0')}`,
                    activity: activity
                };
                
                console.log('FINAL RESULT:', result);
                console.log('===================');
                return result;
            }
            
            // Pattern 2: Just activity (use current time)
            const now = new Date();
            const currentMin = now.getMinutes();
            const roundedMin = Math.floor(currentMin / settings.interval) * settings.interval;
            const startTime = `${String(now.getHours()).padStart(2, '0')}:${String(roundedMin).padStart(2, '0')}`;
            
            const endDate = new Date(now);
            endDate.setMinutes(roundedMin + settings.interval);
            const endTime = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
            
            console.log('Using current time:', { startTime, endTime });
            return {
                startTime: startTime,
                endTime: endTime,
                activity: input
            };
        }

        function changeWeek(direction) {
            currentDate.setDate(currentDate.getDate() + (direction * 7));
            updateDateInput();
            renderTimeline();
            updateStats();
            if (currentView === 'week') {
                renderWeekView();
            }
        }

        function goToToday() {
            currentDate = new Date();
            updateDateInput();
            renderTimeline();
            updateStats();
            if (currentView === 'week') {
                renderWeekView();
            }
        }

        function updateDateInput() {
            document.getElementById('dateInput').value = currentDate.toISOString().split('T')[0];
        }

        function logActivity() {
            const input = document.getElementById('activityInput').value;
            if (!input.trim()) {
                alert('Please enter an activity!');
                return;
            }

            const parsed = parseTimeInput(input);
            
            // DEBUG: Log what was parsed
            console.log('Input:', input);
            console.log('Parsed:', parsed);
            
            const dateKey = currentDate.toISOString().split('T')[0];
            
            if (!schedule[dateKey]) {
                schedule[dateKey] = {};
            }

            // Fill all time blocks in the range
            const blocks = getTimeBlocksInRange(parsed.startTime, parsed.endTime);
            
            // DEBUG: Show what's about to be filled
            alert(`PARSED TIMES:
Start: ${parsed.startTime} (${formatTime12Hour(parsed.startTime)})
End: ${parsed.endTime} (${formatTime12Hour(parsed.endTime)})
Activity: ${parsed.activity}

SLOTS TO FILL: ${blocks.join(', ')}

If this is WRONG, screenshot this!`);
            
            // DEBUG: Log the blocks that will be filled
            console.log('Blocks to fill:', blocks);
            
            if (blocks.length === 0) {
                const debugInfo = `
Debug Info:
- Your input: "${input}"
- Parsed start time: ${parsed.startTime}
- Parsed end time: ${parsed.endTime}
- Current interval: ${settings.interval} minutes
- Day starts at: ${settings.dayStart}
- Day ends at: ${settings.dayEnd}

Possible issues:
1. Times might be outside your day range (check Settings)
2. Make sure to include AM/PM (e.g., "9 am to 10 am")
3. End time must be after start time
                `;
                console.error(debugInfo);
                alert(`No time slots found between ${formatTime12Hour(parsed.startTime)} and ${formatTime12Hour(parsed.endTime)}.\n\nCheck the console (F12) for details, or:\n- Add AM/PM to your times\n- Check Settings to adjust your day hours\n- Make sure end time is after start time`);
                return;
            }
            
            blocks.forEach(block => {
                schedule[dateKey][block] = {
                    activity: parsed.activity,
                    type: selectedColor
                };
            });

            saveSchedule();
            renderTimeline();
            updateStats();
            document.getElementById('activityInput').value = '';
            
            // Update last activity time for AI check-in system
            lastActivityTime = Date.now();
            
            // Show success feedback with exact slots filled
            const slotsText = blocks.length === 1 ? 'slot' : 'slots';
            showNotification(`‚úÖ Logged "${parsed.activity}" in ${blocks.length} ${slotsText} (${formatTime12Hour(parsed.startTime)} - ${formatTime12Hour(parsed.endTime)})`);
        }

        function getTimeBlocksInRange(startTime, endTime) {
            const blocks = [];
            const [startH, startM] = startTime.split(':').map(Number);
            const [endH, endM] = endTime.split(':').map(Number);
            
            // Use a fixed reference date (today) for time calculations
            const referenceDate = new Date(2024, 0, 1); // Fixed date for time-only calculations
            
            let current = new Date(referenceDate);
            current.setHours(startH, startM, 0, 0);
            
            const end = new Date(referenceDate);
            end.setHours(endH, endM, 0, 0);
            
            while (current < end) {
                const timeStr = `${String(current.getHours()).padStart(2, '0')}:${String(current.getMinutes()).padStart(2, '0')}`;
                blocks.push(timeStr);
                current.setMinutes(current.getMinutes() + settings.interval);
            }
            
            return blocks;
        }

        function generateTimeBlocks() {
            const blocks = [];
            const [startH, startM] = settings.dayStart.split(':').map(Number);
            const [endH, endM] = settings.dayEnd.split(':').map(Number);
            
            // Use a fixed reference date for time calculations
            const referenceDate = new Date(2024, 0, 1);
            
            let current = new Date(referenceDate);
            current.setHours(startH, startM, 0, 0);
            
            const end = new Date(referenceDate);
            end.setHours(endH, endM, 0, 0);
            
            while (current <= end) {
                const timeStr = `${String(current.getHours()).padStart(2, '0')}:${String(current.getMinutes()).padStart(2, '0')}`;
                blocks.push(timeStr);
                current.setMinutes(current.getMinutes() + settings.interval);
            }
            
            return blocks;
        }

        function formatTime12Hour(time24) {
            const [hours, minutes] = time24.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const hours12 = hours % 12 || 12;
            return `${hours12}:${String(minutes).padStart(2, '0')} ${period}`;
        }

        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            timeline.innerHTML = '';
            
            const blocks = generateTimeBlocks();
            const dateKey = currentDate.toISOString().split('T')[0];
            const daySchedule = schedule[dateKey] || {};
            
            blocks.forEach((time, index) => {
                const block = document.createElement('div');
                block.className = 'time-block';
                
                const timeLabel = document.createElement('div');
                timeLabel.className = 'time-label';
                
                // Calculate end time for this slot
                const [hours, minutes] = time.split(':').map(Number);
                const endDate = new Date(2024, 0, 1, hours, minutes);
                endDate.setMinutes(endDate.getMinutes() + settings.interval);
                const endTime = `${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;
                
                // Show range: "9:00 AM - 9:30 AM"
                timeLabel.textContent = `${formatTime12Hour(time)} - ${formatTime12Hour(endTime)}`;
                
                const content = document.createElement('div');
                content.className = 'time-content';
                
                if (daySchedule[time]) {
                    block.classList.add('filled', daySchedule[time].type);
                    content.textContent = daySchedule[time].activity;
                    
                    // Add click to clear functionality
                    block.onclick = () => clearTimeSlot(time);
                } else {
                    content.classList.add('empty');
                    content.textContent = 'Free';
                }
                
                block.appendChild(timeLabel);
                block.appendChild(content);
                timeline.appendChild(block);
            });
        }

        function clearTimeSlot(time) {
            if (confirm(`Clear activity at ${formatTime12Hour(time)}?`)) {
                const dateKey = currentDate.toISOString().split('T')[0];
                if (schedule[dateKey] && schedule[dateKey][time]) {
                    delete schedule[dateKey][time];
                    saveSchedule();
                    renderTimeline();
                    updateStats();
                    showNotification(`üóëÔ∏è Cleared ${formatTime12Hour(time)}`);
                }
            }
        }

        function updateStats() {
            const dateKey = currentDate.toISOString().split('T')[0];
            const daySchedule = schedule[dateKey] || {};
            
            let productive = 0, neutral = 0, unproductive = 0;
            
            Object.values(daySchedule).forEach(entry => {
                if (entry.type === 'productive') productive++;
                else if (entry.type === 'neutral') neutral++;
                else if (entry.type === 'unproductive') unproductive++;
            });
            
            const interval = settings.interval / 60; // Convert to hours
            
            document.getElementById('productiveHours').textContent = (productive * interval).toFixed(1);
            document.getElementById('neutralHours').textContent = (neutral * interval).toFixed(1);
            document.getElementById('unproductiveHours').textContent = (unproductive * interval).toFixed(1);
            
            const total = productive + neutral + unproductive;
            const score = total > 0 ? Math.round((productive / total) * 100) : 0;
            document.getElementById('productivityScore').textContent = score + '%';
            
            // NEW: Update motivational features
            updateMotivation(productive * interval, score);
            updateComparison(productive * interval);
        }

        function updateMotivation(productiveHours, score) {
            const banner = document.getElementById('motivationBanner');
            const title = document.getElementById('motivationTitle');
            const message = document.getElementById('motivationMessage');
            const streakBadge = document.getElementById('streakBadge');
            
            // Calculate streak
            const streak = calculateStreak();
            
            // Show banner only if there's data TODAY
            if (productiveHours > 0) {
                banner.style.display = 'block';
                
                // Motivational messages based on HOURS, not just percentage
                if (productiveHours >= 8) {
                    title.textContent = 'üî• Absolute Legend!';
                    message.textContent = `${productiveHours.toFixed(1)} productive hours! You're crushing it today!`;
                } else if (productiveHours >= 6) {
                    title.textContent = 'üí™ Outstanding!';
                    message.textContent = `${productiveHours.toFixed(1)} hours of solid productivity. Keep the momentum!`;
                } else if (productiveHours >= 4) {
                    title.textContent = 'üëç Great Progress!';
                    message.textContent = `${productiveHours.toFixed(1)} productive hours. You're doing well!`;
                } else if (productiveHours >= 2) {
                    title.textContent = 'üéØ Good Start!';
                    message.textContent = `${productiveHours.toFixed(1)} hours logged. Keep building!`;
                } else {
                    title.textContent = '‚ú® You Started!';
                    message.textContent = `${productiveHours.toFixed(1)} hours - every bit counts. Keep going!`;
                }
                
                // Show streak badge only if streak > 0
                if (streak > 0) {
                    const streakEmoji = streak >= 7 ? 'üî•' : streak >= 3 ? '‚ö°' : '‚ú®';
                    const streakText = streak === 1 ? 'Started your streak!' : `${streak} Day Streak!`;
                    streakBadge.innerHTML = `<span class="streak-badge">${streakEmoji} ${streakText}</span>`;
                } else {
                    streakBadge.innerHTML = '';
                }
            } else {
                // No data today - hide banner
                banner.style.display = 'none';
            }
        }

        function updateComparison(todayProductiveHours) {
            const card = document.getElementById('comparisonCard');
            const yesterdayValue = document.getElementById('yesterdayValue');
            const todayValue = document.getElementById('todayValue');
            const differenceValue = document.getElementById('differenceValue');
            
            // Get yesterday's data
            const yesterday = new Date(currentDate);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayKey = yesterday.toISOString().split('T')[0];
            const yesterdaySchedule = schedule[yesterdayKey] || {};
            
            let yesterdayProductive = 0;
            Object.values(yesterdaySchedule).forEach(entry => {
                if (entry.type === 'productive') yesterdayProductive++;
            });
            
            const yesterdayHours = (yesterdayProductive * settings.interval / 60).toFixed(1);
            
            // Only show if we have data for both days
            if (todayProductiveHours > 0 || yesterdayProductive > 0) {
                card.style.display = 'block';
                
                yesterdayValue.textContent = `${yesterdayHours} hours`;
                todayValue.textContent = `${todayProductiveHours.toFixed(1)} hours`;
                
                const diff = todayProductiveHours - parseFloat(yesterdayHours);
                const diffAbs = Math.abs(diff).toFixed(1);
                
                if (diff > 0) {
                    differenceValue.innerHTML = `<span class="better">‚Üó +${diffAbs}h better! üéâ</span>`;
                    differenceValue.className = 'comparison-value better';
                } else if (diff < 0) {
                    differenceValue.innerHTML = `<span class="worse">‚Üò ${diffAbs}h less</span>`;
                    differenceValue.className = 'comparison-value worse';
                } else {
                    differenceValue.textContent = 'Same as yesterday';
                    differenceValue.className = 'comparison-value';
                }
            } else {
                card.style.display = 'none';
            }
        }

        function calculateStreak() {
            let streak = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Start of today
            
            // Check each day going backwards from today
            for (let i = 0; i < 365; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateKey = checkDate.toISOString().split('T')[0];
                const daySchedule = schedule[dateKey] || {};
                
                // Count productive time slots for this day
                let productiveCount = 0;
                Object.values(daySchedule).forEach(entry => {
                    if (entry.type === 'productive') {
                        productiveCount++;
                    }
                });
                
                // Day has productive time - continue streak
                if (productiveCount > 0) {
                    streak++;
                } else {
                    // No productive time on this day
                    if (i === 0) {
                        // Today has no data yet - don't break streak, just return 0
                        return 0;
                    } else {
                        // Past day with no data - streak is broken
                        break;
                    }
                }
            }
            
            return streak;
        }

        // ===== AI CHECK-IN SYSTEM =====
        
        function startAICheckinSystem() {
            console.log('ü§ñ AI Check-in system started');
            
            // Clear any existing timer
            if (aiCheckinTimer) {
                clearInterval(aiCheckinTimer);
            }
            
            // Don't start if disabled
            if (settings.aiCheckinInterval === 0) {
                console.log('AI check-ins disabled');
                return;
            }
            
            // Run check every minute (we'll only act on the interval)
            aiCheckinTimer = setInterval(() => {
                checkIfAIShouldMessage();
            }, 60 * 1000); // Check every minute
            
            console.log(`AI will check in every ${settings.aiCheckinInterval} minutes`);
        }

        function checkIfAIShouldMessage() {
            // Don't check if interval is 0 (disabled)
            if (settings.aiCheckinInterval === 0) return;
            
            // Check if enough time has passed since last check-in
            const now = Date.now();
            const timeSinceLastCheckin = (now - lastCheckinTime) / 1000 / 60; // minutes
            
            if (timeSinceLastCheckin < settings.aiCheckinInterval) {
                return; // Not time yet
            }
            
            // Check if we're in Do Not Disturb hours
            if (isInDNDHours()) {
                console.log('In DND hours, skipping check-in');
                return;
            }
            
            // Decide what type of message to send
            const messageType = decideCheckinType();
            
            if (messageType) {
                sendAICheckin(messageType);
                lastCheckinTime = now;
            }
        }

        function isInDNDHours() {
            if (!settings.dndStart || !settings.dndEnd) return false;
            
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const [dndStartH, dndStartM] = settings.dndStart.split(':').map(Number);
            const [dndEndH, dndEndM] = settings.dndEnd.split(':').map(Number);
            
            const dndStart = dndStartH * 60 + dndStartM;
            const dndEnd = dndEndH * 60 + dndEndM;
            
            if (dndStart < dndEnd) {
                // Normal case: 22:00 to 08:00 next day
                return currentTime >= dndStart && currentTime <= dndEnd;
            } else {
                // Crosses midnight: 22:00 to 08:00
                return currentTime >= dndStart || currentTime <= dndEnd;
            }
        }

        function decideCheckinType() {
            const now = Date.now();
            const dateKey = currentDate.toISOString().split('T')[0];
            const todaySchedule = schedule[dateKey] || {};
            
            // Count productive activities today
            let productiveCount = 0;
            let unproductiveCount = 0;
            let totalCount = 0;
            let lastLogTime = null;
            
            Object.entries(todaySchedule).forEach(([time, entry]) => {
                totalCount++;
                if (entry.type === 'productive') productiveCount++;
                if (entry.type === 'unproductive') unproductiveCount++;
                
                // Find most recent log
                const [hours, mins] = time.split(':').map(Number);
                const logDate = new Date();
                logDate.setHours(hours, mins, 0, 0);
                if (!lastLogTime || logDate > lastLogTime) {
                    lastLogTime = logDate;
                }
            });
            
            const timeSinceLastLog = lastLogTime ? (now - lastLogTime.getTime()) / 1000 / 60 : 999;
            const currentHour = new Date().getHours();
            const streak = calculateStreak();
            
            // Priority 1: Inactivity (haven't logged in 2+ hours)
            if (settings.checkinInactivity && timeSinceLastLog >= 120) {
                return 'inactivity';
            }
            
            // Priority 2: Streak protection (evening, no activity today)
            if (settings.checkinStreak && currentHour >= 18 && totalCount === 0 && streak > 0) {
                return 'streak';
            }
            
            // Priority 3: Productivity praise (3+ productive hours)
            if (settings.checkinPraise && productiveCount >= 6) { // 6 slots = 3 hours at 30min
                return 'praise';
            }
            
            // Priority 4: End of day review (8 PM and not done today)
            if (settings.checkinEndOfDay && currentHour === 20 && !localStorage.getItem('eod_' + dateKey)) {
                localStorage.setItem('eod_' + dateKey, 'true');
                return 'endofday';
            }
            
            // Priority 5: Too much unproductive time
            if (unproductiveCount >= 4) {
                return 'unproductive';
            }
            
            return null; // No message needed
        }

        function sendAICheckin(type) {
            console.log('ü§ñ Sending AI check-in:', type);
            
            // Open AI chat
            const container = document.getElementById('aiChatContainer');
            if (!container.classList.contains('active')) {
                container.classList.add('active');
            }
            
            // Generate message based on type
            let message = '';
            
            switch(type) {
                case 'inactivity':
                    message = "Hey! I haven't seen any activity from you in a while. What have you been working on? I can help you log it! üìù";
                    break;
                    
                case 'streak':
                    const streak = calculateStreak();
                    message = `üî• Don't break your ${streak}-day streak! You haven't logged anything today yet. Even 30 minutes counts!`;
                    break;
                    
                case 'praise':
                    message = "Wow! You've been absolutely crushing it today! üí™ Your productivity is on fire! Want to keep going or take a well-deserved break?";
                    break;
                    
                case 'endofday':
                    message = "The day is almost over! üåô How did it go? Let's review your productivity and celebrate your wins!";
                    break;
                    
                case 'unproductive':
                    message = "I noticed you've been distracted lately. That's totally okay! üòä Want to talk about what's getting in the way? I'm here to help you refocus!";
                    break;
            }
            
            // Add the AI message
            addAIMessage(message);
            
            // Show notification if app is in background
            showNotification('ü§ñ TimeFlow: ' + message.substring(0, 50) + '...');
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('dayView').classList.toggle('active', view === 'day');
            document.getElementById('weekView').classList.toggle('active', view === 'week');
            
            if (view === 'week') {
                renderWeekView();
            }
        }

        function renderWeekView() {
            const grid = document.getElementById('weekGrid');
            grid.innerHTML = '';
            
            // Generate week dates
            const weekStart = new Date(currentDate);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay()); // Start from Sunday
            
            // Headers
            grid.appendChild(createCell('Time', 'week-header'));
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(date.getDate() + i);
                const header = `${days[i]} ${date.getMonth() + 1}/${date.getDate()}`;
                grid.appendChild(createCell(header, 'week-header'));
            }
            
            // Time blocks
            const blocks = generateTimeBlocks();
            blocks.forEach(time => {
                grid.appendChild(createCell(formatTime12Hour(time), 'week-cell time-label'));
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(date.getDate() + i);
                    const dateKey = date.toISOString().split('T')[0];
                    const daySchedule = schedule[dateKey] || {};
                    
                    const cell = createCell('', 'week-cell');
                    if (daySchedule[time]) {
                        cell.textContent = daySchedule[time].activity;
                        cell.style.background = `var(--${daySchedule[time].type === 'productive' ? 'productive' : daySchedule[time].type === 'neutral' ? 'neutral' : 'unproductive'})`;
                        cell.style.opacity = '0.3';
                        cell.style.color = 'white';
                    }
                    grid.appendChild(cell);
                }
            });
        }

        function createCell(text, className) {
            const cell = document.createElement('div');
            cell.className = className;
            cell.textContent = text;
            return cell;
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            document.getElementById('dayStart').value = settings.dayStart;
            document.getElementById('dayEnd').value = settings.dayEnd;
            document.getElementById('intervalSelect').value = settings.interval;
            
            // Load AI check-in settings
            document.getElementById('aiCheckinInterval').value = settings.aiCheckinInterval || 30;
            document.getElementById('checkinInactivity').checked = settings.checkinInactivity !== false;
            document.getElementById('checkinStreak').checked = settings.checkinStreak !== false;
            document.getElementById('checkinPraise').checked = settings.checkinPraise !== false;
            document.getElementById('checkinEndOfDay').checked = settings.checkinEndOfDay !== false;
            document.getElementById('dndStart').value = settings.dndStart || '';
            document.getElementById('dndEnd').value = settings.dndEnd || '';
            
            // Load API key if exists
            const apiKey = localStorage.getItem('openai_api_key');
            if (apiKey) {
                document.getElementById('apiKeyInput').value = apiKey;
            }
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
        }

        function saveSettings() {
            const oldInterval = settings.interval;
            const oldCheckinInterval = settings.aiCheckinInterval;
            
            settings.dayStart = document.getElementById('dayStart').value;
            settings.dayEnd = document.getElementById('dayEnd').value;
            settings.interval = parseInt(document.getElementById('intervalSelect').value);
            
            // Save AI check-in settings
            settings.aiCheckinInterval = parseInt(document.getElementById('aiCheckinInterval').value);
            settings.checkinInactivity = document.getElementById('checkinInactivity').checked;
            settings.checkinStreak = document.getElementById('checkinStreak').checked;
            settings.checkinPraise = document.getElementById('checkinPraise').checked;
            settings.checkinEndOfDay = document.getElementById('checkinEndOfDay').checked;
            settings.dndStart = document.getElementById('dndStart').value;
            settings.dndEnd = document.getElementById('dndEnd').value;
            
            // Save API key
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
                showNotification('‚öôÔ∏è Settings saved! AI Assistant is now active.');
            } else {
                localStorage.removeItem('openai_api_key');
            }
            
            localStorage.setItem('timeflow_settings', JSON.stringify(settings));
            closeSettings();
            
            // If check-in interval changed, restart the timer
            if (oldCheckinInterval !== settings.aiCheckinInterval) {
                startAICheckinSystem();
                if (settings.aiCheckinInterval === 0) {
                    showNotification('ü§ñ AI check-ins disabled');
                } else {
                    showNotification(`ü§ñ AI will check in every ${settings.aiCheckinInterval} minutes`);
                }
            }
            
            // If interval changed, regenerate everything
            if (oldInterval !== settings.interval) {
                renderTimeline();
                if (currentView === 'week') {
                    renderWeekView();
                }
                showNotification('‚öôÔ∏è Timeline updated to ' + settings.interval + ' minute intervals.');
            } else {
                renderTimeline();
            }
            
            updateStats();
        }

        function loadSettings() {
            const saved = localStorage.getItem('timeflow_settings');
            if (saved) {
                settings = JSON.parse(saved);
            }
        }

        function saveSchedule() {
            localStorage.setItem('timeflow_schedule', JSON.stringify(schedule));
        }

        function loadSchedule() {
            const saved = localStorage.getItem('timeflow_schedule');
            if (saved) {
                schedule = JSON.parse(saved);
            }
        }

        function showNotification(message) {
            // Simple notification - you can make this fancier
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--productive);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Keyboard shortcut: Enter to log
        document.getElementById('activityInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                logActivity();
            }
        });

        // AI Chat functionality
        let conversationHistory = [];
        let isAIThinking = false;

        function toggleAIChat() {
            const container = document.getElementById('aiChatContainer');
            container.classList.toggle('active');
            
            // If opening for first time, show welcome message
            if (container.classList.contains('active') && conversationHistory.length === 0) {
                setTimeout(() => {
                    addAIMessage("Hey! I'm your productivity assistant. I can help you plan your day, track your activities, and keep you accountable. What would you like to do?");
                }, 500);
            }
        }

        function addUserMessage(message) {
            const messagesContainer = document.getElementById('aiMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'user-message';
            messageDiv.innerHTML = `
                <div class="message-label">You</div>
                <div class="message-content">${message}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addAIMessage(message) {
            const messagesContainer = document.getElementById('aiMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ai-message';
            messageDiv.innerHTML = `
                <div class="message-label">AI Assistant</div>
                <div class="message-content">${message}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('aiMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message typing-indicator';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            
            if (!message || isAIThinking) return;
            
            // Add user message
            addUserMessage(message);
            input.value = '';
            
            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: message
            });
            
            // Show typing indicator
            isAIThinking = true;
            document.getElementById('aiSendBtn').disabled = true;
            showTypingIndicator();
            
            try {
                // Get current schedule context
                const dateKey = currentDate.toISOString().split('T')[0];
                const todaySchedule = schedule[dateKey] || {};
                const scheduleText = formatScheduleForAI(todaySchedule);
                
                // Build system message
                const systemMessage = `You are a friendly, motivating productivity assistant integrated into a time-tracking app called TimeFlow. 

Current date: ${currentDate.toDateString()}
User's schedule for today:
${scheduleText}

Your role:
- Help users plan their day
- Parse natural language time descriptions and help them log activities
- Analyze their productivity patterns
- Provide encouragement and accountability
- Be conversational, supportive, and concise

When users describe their schedule (e.g., "I studied from 9 to 11, then had lunch, then went to gym"), parse it and offer to log it for them in this format:
"I can log that for you:
‚Ä¢ 9:00 AM - 11:00 AM: Studying
‚Ä¢ 11:00 AM - 12:00 PM: Lunch  
‚Ä¢ 12:00 PM - 1:00 PM: Gym

Would you like me to add these to your schedule?"

Keep responses SHORT and actionable. Be encouraging but honest about productivity.`;

                // Build messages array for OpenAI
                const messages = [
                    { role: 'system', content: systemMessage },
                    ...conversationHistory
                ];

                // Get API key from localStorage (user will add it)
                const apiKey = localStorage.getItem('openai_api_key');
                
                if (!apiKey) {
                    throw new Error('API key not configured');
                }

                // Call OpenAI API
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: messages,
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API request failed');
                }

                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    const aiResponse = data.choices[0].message.content;
                    
                    // Add to conversation history
                    conversationHistory.push({
                        role: 'assistant',
                        content: aiResponse
                    });
                    
                    // Show AI response
                    hideTypingIndicator();
                    addAIMessage(aiResponse);
                } else {
                    throw new Error('Invalid response from AI');
                }
                
            } catch (error) {
                console.error('AI Error:', error);
                hideTypingIndicator();
                
                if (error.message === 'API key not configured') {
                    addAIMessage("‚ö†Ô∏è OpenAI API key not set up yet! Click the Settings button and add your API key to enable AI features. Don't worry, your key is stored locally and never sent anywhere except OpenAI.");
                } else {
                    addAIMessage(`Sorry, I encountered an error: ${error.message}. Please check your API key in Settings.`);
                }
            } finally {
                isAIThinking = false;
                document.getElementById('aiSendBtn').disabled = false;
            }
        }

        function formatScheduleForAI(daySchedule) {
            if (Object.keys(daySchedule).length === 0) {
                return "No activities logged yet today.";
            }
            
            let scheduleText = "";
            const sortedTimes = Object.keys(daySchedule).sort();
            
            sortedTimes.forEach(time => {
                const activity = daySchedule[time];
                scheduleText += `${formatTime12Hour(time)}: ${activity.activity} (${activity.type})
`;
            });
            
            return scheduleText;
        }

        function sendQuickMessage(message) {
            document.getElementById('aiInput').value = message;
            sendAIMessage();
        }

        // AI input enter key
        document.getElementById('aiInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAIMessage();
            }
        });

        // AI Chat Voice Recording
        let aiMediaRecorder = null;
        let aiAudioChunks = [];
        let isAIRecording = false;

        async function toggleAIRecording() {
            if (isAIRecording) {
                stopAIRecording();
            } else {
                await startAIRecording();
            }
        }

        async function startAIRecording() {
            try {
                // Check if we're on HTTPS or localhost
                const isSecure = window.location.protocol === 'https:' || 
                                window.location.hostname === 'localhost' || 
                                window.location.hostname === '127.0.0.1';
                
                if (!isSecure && /iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                    addAIMessage('üì± Voice recording on mobile requires HTTPS. Upload this file to GitHub Pages (free) or type your message instead!');
                    return;
                }

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                aiMediaRecorder = new MediaRecorder(stream);
                aiAudioChunks = [];

                aiMediaRecorder.ondataavailable = (event) => {
                    aiAudioChunks.push(event.data);
                };

                aiMediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(aiAudioChunks, { type: 'audio/webm' });
                    await transcribeAIAudio(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };

                aiMediaRecorder.start();
                isAIRecording = true;

                const btn = document.getElementById('aiRecordBtn');
                btn.innerHTML = 'üî¥';
                btn.style.background = 'var(--unproductive)';
                
            } catch (error) {
                console.error('Microphone error:', error);
                
                if (error.name === 'NotAllowedError') {
                    addAIMessage('üé§ Microphone permission denied. Please allow microphone access in your browser settings and refresh the page.');
                } else {
                    addAIMessage('Could not access microphone: ' + error.message);
                }
            }
        }

        function stopAIRecording() {
            if (aiMediaRecorder && isAIRecording) {
                aiMediaRecorder.stop();
                isAIRecording = false;

                const btn = document.getElementById('aiRecordBtn');
                btn.innerHTML = 'üé§';
                btn.style.background = 'var(--productive)';
            }
        }

        async function transcribeAIAudio(audioBlob) {
            try {
                const btn = document.getElementById('aiRecordBtn');
                btn.innerHTML = '‚è≥';
                btn.disabled = true;

                const apiKey = localStorage.getItem('openai_api_key');
                if (!apiKey) {
                    addAIMessage('Please add your OpenAI API key in Settings first!');
                    btn.innerHTML = 'üé§';
                    btn.disabled = false;
                    return;
                }

                const formData = new FormData();
                formData.append('file', audioBlob, 'audio.webm');
                formData.append('model', 'whisper-1');
                formData.append('language', 'en');
                formData.append('prompt', 'Conversation about daily schedule, activities, and productivity.');

                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Transcription failed');
                }

                const data = await response.json();
                const transcript = data.text;

                console.log('=== AI CHAT WHISPER ===');
                console.log('Transcribed:', transcript);
                console.log('======================');

                // Put transcribed text in input and send
                document.getElementById('aiInput').value = transcript;
                
                btn.innerHTML = 'üé§';
                btn.disabled = false;
                btn.style.background = 'var(--productive)';
                
                // Auto-send after transcription
                sendAIMessage();

            } catch (error) {
                console.error('Transcription error:', error);
                addAIMessage('Could not transcribe audio. Please check your API key and try again.');
                
                const btn = document.getElementById('aiRecordBtn');
                btn.innerHTML = 'üé§';
                btn.disabled = false;
                btn.style.background = 'var(--productive)';
            }
        }

        // PWA Installation
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            const installBanner = document.createElement('div');
            installBanner.id = 'installBanner';
            installBanner.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                right: 20px;
                background: linear-gradient(135deg, var(--productive), var(--accent));
                color: white;
                padding: 1rem;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: space-between;
                animation: slideUp 0.3s ease;
            `;
            installBanner.innerHTML = `
                <div style="flex: 1;">
                    <strong style="display: block; margin-bottom: 0.3rem;">üì± Install TimeFlow</strong>
                    <span style="font-size: 0.9rem; opacity: 0.9;">Get the app on your home screen!</span>
                </div>
                <button onclick="installPWA()" style="
                    background: white;
                    color: var(--productive);
                    border: none;
                    padding: 0.6rem 1.2rem;
                    border-radius: 8px;
                    font-weight: 700;
                    cursor: pointer;
                    margin-left: 1rem;
                ">Install</button>
                <button onclick="dismissInstall()" style="
                    background: transparent;
                    color: white;
                    border: 1px solid white;
                    padding: 0.6rem;
                    border-radius: 8px;
                    cursor: pointer;
                    margin-left: 0.5rem;
                ">‚úï</button>
            `;
            document.body.appendChild(installBanner);
        }

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User installed PWA');
                        showNotification('üéâ App installed! Check your home screen!');
                    }
                    deferredPrompt = null;
                    dismissInstall();
                });
            }
        }

        function dismissInstall() {
            const banner = document.getElementById('installBanner');
            if (banner) {
                banner.style.animation = 'slideDown 0.3s ease';
                setTimeout(() => banner.remove(), 300);
            }
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('Service Worker registered:', registration);
                })
                .catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            // Ask for permission after user has used app for a bit
            setTimeout(() => {
                Notification.requestPermission().then(permission => {
                    console.log('Notification permission:', permission);
                });
            }, 60000); // Ask after 1 minute of use
        }
    </script>
</body>
</html>
